gdjs.HSHG=gdjs.HSHG||{},function(t,e){function l(){var t,e,l,s,i,n;for(t=0;t<this._globalObjects.length;t++)e=this._globalObjects[t],s=e.HSHG,l=s.grid,i=e.getAABB(),(n=l.toHash(i.min[0],i.min[1]))!==s.hash&&(l.removeObject(e),l.addObject(e,n))}function s(){}function i(t,e){var l=t.getAABB(),s=e.getAABB();return!(l.min[0]>s.max[0]||l.min[1]>s.max[1]||l.max[0]<s.min[0]||l.max[1]<s.min[1])}function n(t,e){return Math.max(Math.abs(e[0]-t[0]),Math.abs(e[1]-t[1]))}function o(){this.MAX_OBJECT_CELL_DENSITY=1/8,this.INITIAL_GRID_LENGTH=256,this.HIERARCHY_FACTOR=2,this.HIERARCHY_FACTOR_SQRT=Math.SQRT2,this.UPDATE_METHOD=l,this._grids=[],this._globalObjects=[]}function h(t,e,l){this.cellSize=t,this.inverseCellSize=1/t,this.rowColumnCount=~~Math.sqrt(e),this.xyHashMask=this.rowColumnCount-1,this.occupiedCells=[],this.allCells=Array(this.rowColumnCount*this.rowColumnCount),this.allObjects=[],this.sharedInnerOffsets=[],this._parentHierarchy=l||null}function r(){this.objectContainer=[],this.neighborOffsetArray,this.occupiedCellsIndex=null,this.allCellsIndex=null}o.prototype.addObject=function(t){var e,l,s,i=t.getAABB(),o=n(i.min,i.max),r,a;if(t.HSHG={globalObjectsIndex:this._globalObjects.length},this._globalObjects.push(t),0===this._grids.length)s=o*this.HIERARCHY_FACTOR_SQRT,a=new h(s,this.INITIAL_GRID_LENGTH,this),a.initCells(),a.addObject(t),this._grids.push(a);else{for(e=0,l=0;l<this._grids.length;l++)if(r=this._grids[l],e=r.cellSize,o<e){if(e/=this.HIERARCHY_FACTOR,o<e){for(;o<e;)e/=this.HIERARCHY_FACTOR;a=new h(e*this.HIERARCHY_FACTOR,this.INITIAL_GRID_LENGTH,this),a.initCells(),a.addObject(t),this._grids.splice(l,0,a)}else r.addObject(t);return}for(;o>=e;)e*=this.HIERARCHY_FACTOR;a=new h(e,this.INITIAL_GRID_LENGTH,this),a.initCells(),a.addObject(t),this._grids.push(a)}},o.prototype.removeObject=function(t){var e=t.HSHG,l,s;{if(void 0===e)throw Error(t+" was not in the HSHG.");l=e.globalObjectsIndex,l===this._globalObjects.length-1?this._globalObjects.pop():(s=this._globalObjects.pop(),s.HSHG.globalObjectsIndex=l,this._globalObjects[l]=s),e.grid.removeObject(t),delete t.HSHG}},o.prototype.update=function(){this.UPDATE_METHOD.call(this)},o.prototype.queryForCollisionWith=function(t,e){var l,s,n,o,h,r,a,c,C,d,u,b,H,g;e.length=0,t.HSHG.excludeMe=!0;var p=t.getAABB(),O=t.HSHG.grid.toHash(p.min[0],p.min[1]),f=t.HSHG.grid.allCells[O];for(broadOverlapTest=i,l=0;l<this._grids.length;l++){if(r=this._grids[l],r.cellSize===t.HSHG.grid.cellSize){for(s=0;s<r.occupiedCells.length;s++){for(a=r.occupiedCells[s],o=0;o<a.objectContainer.length;o++)C=a.objectContainer[o],C.HSHG.excludeMe||!0!==broadOverlapTest(t,C)||e.push(C);for(h=0;h<4;h++)for(d=a.neighborOffsetArray[h],u=r.allCells[a.allCellsIndex+d],o=0;o<u.objectContainer.length;o++)C=u.objectContainer[o],C.HSHG.excludeMe||!0!==broadOverlapTest(t,C)||e.push(C)}for(n=l+1;n<this._grids.length;n++){b=this._grids[n];var j=b.toHash(p.min[0],p.min[1]);for(a=b.allCells[j],h=0;h<a.neighborOffsetArray.length;h++)for(d=a.neighborOffsetArray[h],u=b.allCells[a.allCellsIndex+d],o=0;o<u.objectContainer.length;o++)C=u.objectContainer[o],!0===broadOverlapTest(t,C)&&e.push(C)}break}if(r.cellSize<t.HSHG.grid.cellSize)for(s=0;s<r.allObjects.length;s++){c=r.allObjects[s],H=c.getAABB(),g=t.HSHG.grid.toHash(H.min[0],H.min[1]);var A=!1;for(h=0;h<f.neighborOffsetArray.length;h++)if(d=f.neighborOffsetArray[h],g===f.allCellsIndex+d){A=!0;break}A&&!0===broadOverlapTest(t,c)&&e.push(c)}}delete t.HSHG.excludeMe},o.update_RECOMPUTE=l,o.update_REMOVEALL=s,h.prototype.initCells=function(){var t,e=this.allCells.length,l,s,i=this.rowColumnCount,n,o,h,a,c=[i-1,i,i+1,-1,0,1,-1-i,-i,1-i],C,d,u,b,H=[],g;for(this.sharedInnerOffsets=c,t=0;t<e;t++)g=new r,s=~~(t/this.rowColumnCount),l=~~(t-s*this.rowColumnCount),n=!1,o=!1,h=!1,a=!1,(l+1)%this.rowColumnCount==0?n=!0:l%this.rowColumnCount==0&&(o=!0),(s+1)%this.rowColumnCount==0?h=!0:s%this.rowColumnCount==0&&(a=!0),n||o||h||a?(d=!0===n?1-i:1,C=!0===o?i-1:-1,u=!0===h?-e+i:i,b=!0===a?e-i:-i,H=[C+u,u,d+u,C,0,d,C+b,b,d+b],g.neighborOffsetArray=H):g.neighborOffsetArray=this.sharedInnerOffsets,g.allCellsIndex=t,this.allCells[t]=g},h.prototype.toHash=function(t,e,l){var s,i,n,o;return t<0?(s=-t*this.inverseCellSize,i=this.rowColumnCount-1-(~~s&this.xyHashMask)):(s=t*this.inverseCellSize,i=~~s&this.xyHashMask),e<0?(s=-e*this.inverseCellSize,n=this.rowColumnCount-1-(~~s&this.xyHashMask)):(s=e*this.inverseCellSize,n=~~s&this.xyHashMask),i+n*this.rowColumnCount},h.prototype.addObject=function(t,e){var l,s,i;void 0!==e?s=e:(l=t.getAABB(),s=this.toHash(l.min[0],l.min[1])),i=this.allCells[s],0===i.objectContainer.length&&(i.occupiedCellsIndex=this.occupiedCells.length,this.occupiedCells.push(i)),t.HSHG.objectContainerIndex=i.objectContainer.length,t.HSHG.hash=s,t.HSHG.grid=this,t.HSHG.allGridObjectsIndex=this.allObjects.length,i.objectContainer.push(t),this.allObjects.push(t),this.allObjects.length/this.allCells.length>this._parentHierarchy.MAX_OBJECT_CELL_DENSITY&&this.expandGrid()},h.prototype.removeObject=function(t){var e=t.HSHG,l,s,i,n,o,h;l=e.hash,s=e.objectContainerIndex,i=e.allGridObjectsIndex,n=this.allCells[l],1===n.objectContainer.length?(n.objectContainer.length=0,n.occupiedCellsIndex===this.occupiedCells.length-1?this.occupiedCells.pop():(o=this.occupiedCells.pop(),o.occupiedCellsIndex=n.occupiedCellsIndex,this.occupiedCells[n.occupiedCellsIndex]=o),n.occupiedCellsIndex=null):s===n.objectContainer.length-1?n.objectContainer.pop():(h=n.objectContainer.pop(),h.HSHG.objectContainerIndex=s,n.objectContainer[s]=h),i===this.allObjects.length-1?this.allObjects.pop():(h=this.allObjects.pop(),h.HSHG.allGridObjectsIndex=i,this.allObjects[i]=h)},h.prototype.expandGrid=function(){var t,e,l=this.allCells.length,s=this.rowColumnCount,i=this.xyHashMask,n=4*l,o=~~Math.sqrt(n),h=o-1,r=this.allObjects.slice(0),a,c=Array.prototype.push;for(t=0;t<r.length;t++)this.removeObject(r[t]);for(this.rowColumnCount=o,this.allCells=Array(this.rowColumnCount*this.rowColumnCount),this.xyHashMask=h,this.initCells(),t=0;t<r.length;t++)this.addObject(r[t])},t.HSHG=o,o._private={Grid:h,Cell:r,testAABBOverlap:i,getLongestAABBEdge:n}}(gdjs.HSHG);